services:
  generator:
    build:
      context: ../
      dockerfile: docker/generate.Dockerfile
    working_dir: /app
    command: >
      sh -c '
        set -e
      
        buf generate
        wire ./...
        goose up
      
        pg_dump "postgresql://cashtrack:cashtrack@db:5432/cashtrack" \
          --schema-only \
          --no-owner \
          --no-privileges \
          --no-comments \
          --exclude-table=public.goose_db_version \
          --file=db/schema.raw.sql
      
        echo "-- Generated by \"make generate\". DO NOT EDIT." > db/schema.sql
        sed \
          -e "/\\\\restrict/d" \
          -e "/\\\\unrestrict/d" \
          -e "/^SET /d" \
          -e "/^SELECT pg_catalog\\.set_config/d" \
          -e "/^-- PostgreSQL database dump/d" \
          -e "/^-- Dumped from database version/d" \
          -e "/^-- Dumped by pg_dump version/d" \
          -e "/^-- PostgreSQL database dump complete/d" \
          -e "/^--/d" \
          -e "/^[[:space:]]*$/d" \
          db/schema.raw.sql >> db/schema.sql
      
        rm db/schema.raw.sql
      
        sqlc generate
      '
    volumes:
      - type: bind
        source: ..
        target: /app
    environment:
      GOOSE_DRIVER: postgres
      GOOSE_DBSTRING: postgresql://cashtrack:cashtrack@db:5432/cashtrack
      GOOSE_MIGRATION_DIR: ./db/migrations
    depends_on:
      - db

  db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: cashtrack
      POSTGRES_USER: cashtrack
      POSTGRES_PASSWORD: cashtrack
    ports:
      - "5432"